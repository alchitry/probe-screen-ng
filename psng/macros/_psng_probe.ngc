; Helper macro for containing functionality needed to
; safely perform a G38.3 move.

o<_psng_probe> sub

; Save and autorestore model states
M73

; Paramaters for this macro
#<search_distance> = #1
#<search_direction> = #2
#<search_axis> = #3

O1 if [#<search_axis> GT 3]
; Unknown / Unsupported AXIS for Probe
    O1 return [-99]
O1 endif

; Set incremental mode
G91

; Set Search Feed Rate
F[#<_hal[probe.ps_searchvel]>]

; Check if probe is already tripped
O2 if [#<_hal[motion.probe-input]> EQ 1]
    O2 return [-1]
O2 endif

; Perform the Search
O3 if [#<search_axis> EQ 1]
    ; X Axis
    G38.3 X[#<search_distance>*#<search_direction>]
O3 else if [#<search_axis> EQ 2]
    ; Y Axis
    G38.3 Y[#<search_distance>*#<search_direction>]
O3 else if [#<search_axis> EQ 3]
    ; Z Axis
    G38.3 Z[#<search_distance>*#<search_direction>]
O3 endif

; Check to see if we failed to make contact
O4 if [#5070 EQ 0]
    O4 return [-2]
O4 endif

; Move away
O5 if [#<search_axis> EQ 1]
    ; X Axis
    G1 X[#<_hal[probe.ps_probe_latch]>*#<search_direction>]
O5 else if [#<search_axis> EQ 2]
    ; Y Axis
    G1 Y[#<_hal[probe.ps_probe_latch]>*#<search_direction>]
O5 else if [#<search_axis> EQ 3]
    ; Z Axis
    G1 Z[#<_hal[probe.ps_probe_latch]>*#<search_direction>]
O5 endif

; Allow a half second for the probe input to clear
G4 P0.5

; Set Probe Feed Rate
F[#<_hal[probe.ps_probevel]>]

; Check if probe is already tripped
O6 if [#<_hal[motion.probe-input]> EQ 1]
    O6 return [-1]
O6 endif

; Perform the Probe
O7 if [#<search_axis> EQ 1]
    ; X Axis
    G38.3 X-[#<_hal[probe.ps_probe_latch]>*2*#<search_direction>]
O7 else if [#<search_axis> EQ 2]
    ; Y Axis
    G38.3 Y-[#<_hal[probe.ps_probe_latch]>*2*#<search_direction>]
O7 else if [#<search_axis> EQ 3]
    ; Z Axis
    G38.3 Z-[#<_hal[probe.ps_probe_latch]>*2*#<search_direction>]
O7 endif

; Check to see if we failed to make contact
O8 if [#5070 EQ 0]
    O8 return [-2]
O8 endif

; Set Search Feed Rate
F[#<_hal[probe.ps_searchvel]>]

; Move away and allow a half second for the probe to clear
O9 if [#<search_axis> EQ 1]
    ; X Axis
    G1 X[#<_hal[probe.ps_probe_latch]>*#<search_direction>]
O9 else if [#<search_axis> EQ 2]
    ; Y Axis
    G1 Y[#<_hal[probe.ps_probe_latch]>*#<search_direction>]
O9 else if [#<search_axis> EQ 3]
    ; Z Axis
    G1 Z[#<_hal[probe.ps_probe_latch]>*#<search_direction>]
O9 endif

; Allow a half second for the probe input to clear
G4 P0.5

o<_psng_probe> endsub [0]
M2
